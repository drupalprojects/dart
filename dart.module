<?php

/**
 * @file
 * Integrates DART Ad Tags into your site.
 */

/**
 * The doublclick URL.
 */
define('DART_URL', ($GLOBALS['is_https'] ? 'https://ad.doubleclick.net' : 'http://ad.doubleclick.net'));

/**
 * The maximum number of key|value pair fields to show on forms by defaut.
 */
define('DART_MAX_KEY_VALS', 10);

/**
 * Implements hook_help().
 */
function dart_help($path, $arg) {
  switch ($path) {
    case 'admin/help#dart':
      $output = '<p>' . t('The DART module allows you to integrate Doubleclick ad tags onto your site.') . '</p>';
      $output .= '<p>' . t('This module provides you with a general settings form as well as the ability to create a tag (with all its associated data) in the database. You can then add a simple bit of php to your tpl.php file(s) within your theme to indicate where specific tags should be displayed.') . '</p>';
      $output .= '<p>' . t('In addition, you can tell this module about specific javascript variables that exist on your pages in order to include them in your ad tags. For example, you can include a variable called "channel" with a value of "sports".') . '</p>';
      return $output;
  }
}

/**
 * Implements hook_permission().
 */
function dart_permission() {
  return array(
    'administer DART tags' => array(
      'title' => t('administer DART tags'),
      'description' => t('Users can create, edit and delete DART tags as well as configure how and when DART tags should be displayed.'),
    ),
  );
}

/**
 * Implements hook_theme().
 */
function dart_theme() {
  return array(
    'dart_key_vals_form' => array(
      'render element' => 'form',
      'file' => 'plugins/export_ui/dart_ctools_export_ui.inc',
    ),
    'dart_prefix_site_zone_form' => array(
      'render element' => 'form',
      'file' => 'dart.admin.inc',
    ),
    'dart_tag' => array(
      'variables' => array('tag' => NULL),
      'template' => 'theme/dart_tag',
    ),
  );
}

/**
 * Implements hook_menu().
 */
function dart_menu() {
  $items = array();

  $items['admin/structure/dart_tags/settings'] = array(
    'title' => 'Global DART Settings',
    'type' => MENU_LOCAL_TASK,
    'description' => "Configure your site-wide DART settings.",
    'page callback' => 'drupal_get_form',
    'page arguments' => array('dart_admin_settings'),
    'access arguments' => array('administer DART tags'),
    'file' => 'dart.admin.inc',
    'weight' => 50,
  );
  $items['admin/structure/dart_tags/test_page'] = array(
    'title' => 'DART Test Page',
    'type' => MENU_LOCAL_TASK,
    'description' => "View all your DART tags",
    'page callback' => 'dart_test_page',
    'access arguments' => array('administer DART tags'),
    'file' => 'dart.adtest.inc',
    'weight' => 55,
  );

  return $items;
}

/**
 * Implements hook_libraries_info().
 */
function dart_libraries_info() {
  $libraries['writecapture'] = array(
    'title' => 'Write Capture jQuery Plugin',
    'vendor_url' => 'https://github.com',
    'download_url' => 'https://github.com/downloads/iamnoah/writeCapture/jquery.writeCapture-1.0.5-min.js',
    'files' => array(
      'js' => array(
        'jquery.writeCapture.js' => array(
          'every_page' => TRUE,
          'group' => JS_LIBRARY,
          'preprocess' => 0,
          'scope' => 'header',
          'type' => 'file',
          'weight' => -999,
        ),
      ),
    ),
  );

  return $libraries;
}

/**
 * Implements of hook_token_info().
 */
function dart_token_info() {
  $type = array(
    'name' => t('DART Ad Tags'),
    'description' => t('Tokens related to a given DART ad tag.'),
    'needs-data' => 'tag',
  );

  $tag['ad_categories'] = array(
    'name' => t("DART Ad Categories"),
    'description' => t("The DART Ad Categories or uncategorized taxonomy terms attached to the entities currently being displayed to the user."),
  );
  $tag['url_parts'] = array(
    'name' => t("URL Parts (n)"),
    'description' => t("Given the current URL of http://site.com/path/to/page, [dart_tag:url_parts:2] will be replaced with 'path/to'."),
  );

  return array(
    'types' => array('dart_tag' => $type),
    'tokens' => array('dart_tag' => $tag),
  );
}

/**
 * Implements of hook_token().
 */
function dart_tokens($type, $tokens, array $data = array(), array $options = array()) {
  $replacements = array();

  if ($type == 'dart_tag') {
    foreach ($tokens as $name => $original) {
      switch ($name) {
        case 'ad_categories':
          $term_names = &drupal_static('dart_entity_targeting_terms', array());

          // If a term has been explicitly defined because we are on a term page
          // then add the term to the list.
          // @todo: If http://drupal.org/node/1067120 ever lands, this logic can
          // be moved to dart_entity_view() where it belongs.
          if (isset($data['term'])) {
            $term_names[] = _dart_get_term_value($data['term']);
          }

          $replacements[$original] = implode(',', $term_names);
          break;
      }
    }

    if ($created_tokens = token_find_with_prefix($tokens, 'url_parts')) {
      foreach ($created_tokens as $name => $original) {
        $url_parts = explode('/', $_GET['q']);
        $replacements[$original] = implode('/', array_slice($url_parts, 0, $name));
      }
    }
  }

  return $replacements;
}

/**
 * Implements hook_block_info().
 */
function dart_block_info() {
  $tags = _dart_block_tags();
  $blocks = array();
  foreach ($tags as $tag) {
    $blocks['dart-tag-' . $tag->machinename]['info'] = t('DART tag: !tagname', array('!tagname' => $tag->name));
    $blocks['dart-tag-' . $tag->machinename]['cache'] = DRUPAL_CACHE_PER_PAGE;
  }
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function dart_block_view($delta) {
  $machinename = str_replace('dart-tag-', '', $delta);
  $block['content'] = dart_tag($machinename);
  return $block;
}

/**
 * Implements hook_contextual_links_view_alter().
 */
function dart_contextual_links_view_alter(&$element, &$items) {
  // This hook is called for EVERY set of contextual links on a page.  We first
  // want to check the $element to make sure we are adding a link to the correct
  // list of contextual links. In this case we only want to add a link to blocks
  // created by the "search" module. We just add links using the same array
  // structure as is used by theme_links.
  if (isset($element['#element']['#block']) && strpos($element['#element']['#block']->delta, 'dart-tag-') !== FALSE) {
    $machinename = str_replace('dart-tag-', '', $element['#element']['#block']->delta);
    $element['#links']['dart-tag'] = array(
      'title' => t('Configure DART Tag'),
      'href' => 'admin/structure/dart_tags/list/' . $machinename . '/edit',
    );
  }
}

/**
 * Implements hook_ctools_plugin_directory().
 */
function dart_ctools_plugin_directory($module, $type) {
  // Load the export_ui plugin.
  if ($type == 'export_ui') {
    return 'plugins/export_ui';
  }
}

/**
 * Implements hook_context_plugins().
 */
function dart_context_plugins() {
  $plugins = array();
  $plugins['dart_context_reaction_tags'] = array(
    'handler' => array(
      'path' => drupal_get_path('module', 'dart') . '/plugins/contexts',
      'file' => 'dart_context_reaction_tags.inc',
      'class' => 'dart_context_reaction_tags',
      'parent' => 'context_reaction',
    ),
  );
  $plugins['dart_context_reaction_settings'] = array(
    'handler' => array(
      'path' => drupal_get_path('module', 'dart') . '/plugins/contexts',
      'file' => 'dart_context_reaction_settings.inc',
      'class' => 'dart_context_reaction_settings',
      'parent' => 'context_reaction',
    ),
  );
  return $plugins;
}

/**
 * Implements hook_context_registry().
 */
function dart_context_registry() {
  return array(
    'reactions' => array(
      'dart_tags' => array(
        'title' => t('DART tags'),
        'plugin' => 'dart_context_reaction_tags',
      ),
      'dart_settings' => array(
        'title' => t('DART settings'),
        'plugin' => 'dart_context_reaction_settings',
      ),
    ),
  );
}

/**
 * Implements hook_entity_view().
 */
function dart_entity_view($entity, $type, $view_mode, $langcode) {
  $dart_targeting_terms = &drupal_static('dart_entity_targeting_terms', array());

  if ($view_mode == 'full') {
    // Find all taxonomy terms attached to the given entity and add them to the
    // dart_targeting_terms array. Check each term to see if a DART Ad Category
    // has been assigned to it. If so, add that term to the array instead.
    foreach (element_children($entity->content) as $key) {
      if (array_key_exists('#field_type', $entity->content[$key]) && $entity->content[$key]['#field_type'] == 'taxonomy_term_reference') {
        $terms = field_view_field($type, $entity, $key);
        foreach ($terms['#items'] as $item) {
          if (array_key_exists('taxonomy_term', $item)) {
            $dart_targeting_terms[] = $item['taxonomy_term'];
          }
        }
      }
    }
  }
}

/**
 * Implements hook_dart_tag_alter();
 */
function dart_dart_tag_alter(&$tag) {
  module_load_include('inc', 'dart', 'dart.adtest');
  dart_tag_adtest($tag);
}

/**
 * Wrapper function for outputting a themed dart tag.
 */
function dart_tag($machinename) {
  $output = '';

  // Make sure this is a real tag.
  if (!$tag = dart_tag_load($machinename)) {
    drupal_set_message(t('%machinename is not a valid DART tag.', array('%machinename' => $machinename)), 'error');
    return;
  }

  if (module_exists('context')) {
    // Hide the tag based on the current context.
    if ($plugin = context_get_plugin('reaction', 'dart_tags')) {
      $plugin->execute($tag);
    }
    // Override the tag's settings based on the current context.
    if ($plugin = context_get_plugin('reaction', 'dart_settings')) {
      $plugin->execute($tag);
    }
  }

  if (empty($tag->disabled)) {
    // Build the tag based on its display options.
    // $output = dart_tag_build($tag);
    $output = theme('dart_tag', array('tag' => $tag));
  }

  return $output;
}

/**
 * Return the adtag object matching a DART Tag ID.
 *
 * @param $machinename
 *   The DART tag's unique identifier or empty.
 *
 * @return
 *   If a machinename is provided, the dart tag object with all of its metadata,
 *   if it exists, NULL otherwise. If machinename is empty, a list of all dart
 *   tags.
 */
function dart_tag_load($machinename = '') {
  ctools_include('export');

  // Grab an array of all DART tags or the specificed DART tag.
  if (empty($machinename)) {
    $tags = ctools_export_load_object('dart_tags');
  }
  else {
    $tags = ctools_export_load_object('dart_tags', 'names', array($machinename));
  }

  // Build up the tag objects
  dart_tag_prepare($tags);
  return empty($machinename) ? $tags : array_shift($tags);
}

/**
 * Modify just-loaded DART tags to prepare it for use.
 */
function dart_tag_prepare(&$tags) {
  // Unserialize the settings array.
  foreach ($tags as &$tag) {
    if (is_string($tag->settings)) {
      $tag->settings = unserialize($tag->settings);
    }

    // Build an exhaustive key_vals array to use for display purposes that
    // incorporates global, special & tag-specific key|value pairs.
    $tag->key_vals = array();
    $pos_sz_key_vals = array(
      array(
        'key' => 'pos',
        'val' => $tag->pos,
        'eval' => FALSE,
      ),
      array(
        'key' => 'sz',
        'val' => $tag->sz,
        'eval' => FALSE,
      ));
    $global_key_vals = variable_get('dart_key_vals', array());
    $tag_key_vals = isset($tag->settings['key_vals']) ? $tag->settings['key_vals'] : array();
    $term_key_vals = variable_get('dart_include_taxonomy_terms', 0) ? _dart_get_term_key_vals() : array();
    $contrib_key_vals = module_invoke_all('dart_key_vals', $tag);
    $special_key_vals  = _dart_get_special_key_vals();

    // Merge these key_value arrays together. $special_key_vals must be last.
    $key_vals = array_merge(
      $pos_sz_key_vals,
      $global_key_vals,
      $tag_key_vals,
      $term_key_vals,
      $contrib_key_vals,
      $special_key_vals
    );

    // Use an MD5 hash trick to ensure no duplicate key|value pairs exist.
    $unique_key_vals = array();
    foreach ($key_vals as $pair) {
      $unique_key_vals[md5(serialize($pair))] = $pair;
    }
    $key_vals = array_values($unique_key_vals);

    foreach ($key_vals as $pair) {
      _dart_add_key_val($tag, $pair['key'], $pair['val'], isset($pair['eval']) ? $pair['eval'] : FALSE);
    }

    // Set the prefix.site/zone and slug for this tag.
    $variables = array('prefix', 'site', 'zone', 'slug');
    foreach ($variables as $var) {
      $tag->{$var} = empty($tag->settings['overrides'][$var]) ? variable_get('dart_global_' . $var, '') : $tag->settings['overrides'][$var];
      $tag->{$var} = token_replace($tag->{$var}, _dart_get_token_context($tag), array(
        'clear' => TRUE,
        'sanitize' => TRUE,
      ));
    }
    $tag->slug = ($tag->slug != '<none>' ? $tag->slug : '');

    // Give other modules the opportunity to add information to this tag.
    drupal_alter('dart_tag', $tag);

    // Build data for the noscript tag.
    $tag->noscript = dart_tag_prepare_noscript($tag);
  }
}

/**
 * Build data for the noscript tag.
 */
function dart_tag_prepare_noscript($tag) {
  static $tile = NULL;
  static $ord = 0;

  // Set an initial value for tile. We subtract 1 since we immediately add 1.
  $tile = is_null($tile) ? variable_get('dart_special_tile_init', '0') -1 : $tile;

  // Add the special key|value pairs to the noscript tag.
  $special_key_vals  = _dart_get_special_key_vals();
  foreach ($special_key_vals as $key_val) {
    switch ($key_val['key']) {
      case 'tile':
        $tile++;
        break;
      case 'ord':
        $ord = $ord == 0 ? rand(1000000000, 9999999999) . '?' : $ord;
        break;
    }
  }

  // Begin building the src for the noscript tag.
  $src  = DART_URL . '/ad/' . $tag->prefix . '.' . $tag->site . '/' . $tag->zone . ';';

  // Add global & tag-specific key|value pairs.
  foreach ($tag->key_vals as $key => $vals) {
    foreach ($vals as $val) {
      // Only add key|value pairs that do not require javacript and are not
      // "special" key|value pairs.
      if (!$val['eval'] && !in_array($key, $special_key_vals)) {
        $src .= $key . '=' . $val['val'] . ';';
      }
    }
  }

  // Now add the "special" key|value pairs.
  $src .= $tile ? 'tile=' . $tile . ';' : '';
  $src .= $ord ? 'ord=' . $ord : '';

  return array(
    'src' => $src,
    'href' => str_ireplace('/ad/', '/jump/', $src),
  );
}

/**
 * Change the current active/inactive status for the given tag.
 */
function dart_tag_set_status($tag, $status) {
  ctools_export_crud_set_status('dart_tags', $tag->machinename, $status);
}

/**
 * Implentation of template_preprocess_page().
 */
function dart_preprocess_page(&$variables) {
  // Inject any user-defined javascript.
  $inline_js = variable_get('dart_js', '') . "\n";

  // Add page key|value pairs to the drupal.settings.dart javascript variable.
  $key_vals = _dart_get_page_key_vals();
  foreach ($key_vals as $key => $val) {
    $inline_js .= 'var ' . $key . ' = ' . $val . ';' . "\n";
  }

  // Add settings for loading ads last.
  if (variable_get('dart_load_last', '0')) {
    if ($path = libraries_get_path('writecapture')) {
      drupal_add_js($path . '/jquery.writeCapture.js');
    }
    $inline_js .= 'Drupal.DART.settings.writeTags = false;' . "\n";
    $inline_js .= 'Drupal.DART.settings.loadLastTags = {};' . "\n";
  }

  // Include the inline js & dart.js file. Dart.js must be included first
  // because the inline_js can reference variables defined in dart.js.
  drupal_add_js(drupal_get_path('module', 'dart') . '/dart.js');
  drupal_add_js(trim($inline_js, "\n"), array('type' => 'inline', 'scope' => 'header'));

  // Regenerate scripts variable to incorporate newly added scripts.
  $variables['scripts'] = drupal_get_js();
}

/**
 * Helper function defines the structure of the tag settings array.
 */
function _dart_tag_settings_data_structure() {
  $structure = array(
    'overrides' => array('site', 'zone', 'slug'),
    'options' => array('scriptless', 'method'),
    'key_vals' => array(),
  );

  drupal_alter('dart_tag_settings_data_structure', $structure);

  return $structure;
}

/**
 * Helper function that returns an array of all tags that will
 * be rendered as blocks.
 */
function _dart_block_tags() {
  $block_tags = array();
  $tags = dart_tag_load();

  foreach ($tags as $tag) {
    if ($tag->block) {
      $block_tags[] = $tag;
    }
  }

  return $block_tags;
}

/**
 * Helper function to add a key|value pair to a tag object.
 */
function _dart_add_key_val(&$tag, $key, $val = NULL, $eval = FALSE) {
  if (!empty($val)) {
    $tag->key_vals[$key][] = array(
      'val' => token_replace($val, _dart_get_token_context($tag), array(
        'clear' => TRUE,
        'sanitize' => TRUE,
      )),
      'eval' => $eval,
    );
  }
}

/**
 * Helper function to buil a key|value pair array for special_key_vals.
 */
function _dart_get_special_key_vals() {
  $key_vals = array();

  $special_key_vals = variable_get('dart_special_key_vals', array());
  foreach ($special_key_vals as $key => $val) {
    if (!empty($val)) {
      switch ($key) {
        case 'ord':
          $key_vals[] = array(
            'key' => $key,
            'val' => 'ord',
            'eval' => TRUE,
          );
          break;
        case 'tile':
          $key_vals[] = array(
            'key' => $key,
            'val' => 'tile++',
            'eval' => TRUE,
          );
          break;
      }
    }
  }
  return $key_vals;
}

/**
 * Returns an array of js variables to be included at the top of every page.
 */
function _dart_get_page_key_vals() {
  //$key_vals = array('dart' => array());
  $key_vals = array();

  // Set the dart url
  $key_vals['dart_url'] = '"' . DART_URL . '"';

  // Setup page-wide Dart key|value pairs as varibales.
  foreach (_dart_get_special_key_vals() as $key_val) {
    if (!empty($key_val['val'])) {
      switch ($key_val['key']) {
        case 'ord':
          $key_vals['ord'] = "1000000000 + Math.floor(Math.random() * 900000000)";
          break;
        case 'tile':
          $key_vals['tile'] = variable_get('dart_special_tile_init', '0');
          break;
      }
    }

  }
  return $key_vals;
}

/**
 * Get the key to use while displaying the given term within a DART tag.
 * @param  object $term
 *
 * @return string
 */
function _dart_get_term_key($term) {
  $keys = &drupal_static(__FUNCTION__);

  $keys[$term->tid] = variable_get('dart_term_key', '');
  if (empty($keys[$term->tid])) {
    $vocabulary = taxonomy_vocabulary_load($term->vid);
    $keys[$term->tid] = _dart_term_formatter_full($vocabulary);
  }

  return $keys[$term->tid];
}

/**
 * Return the term object to use as the DART Ad Category given a specific term.
 *
 * @param object $term
 *   The term object to analyze. If it is tagged with a DART Ad Cateegory, then
 *   that term is returned, otherwise the original term is returned unchanged.
 *
 * @return string
 *   The formatted term to be included in an ad tag.
 */
function _dart_get_term_value($term) {
  $values = &drupal_static(__FUNCTION__);

  if (empty($values[$term->tid])) {
    if (!empty($term->field_dart_ad_categories)) {
      $term = taxonomy_term_load($term->field_dart_ad_categories[LANGUAGE_NONE][0]['tid']);
    }

    $function = variable_get('dart_term_formatter', '_dart_term_formatter_tid');
    $values[$term->tid] = $function($term);
  }

  return $values[$term->tid];
}

/**
 * Create an array of key|val pairs based on the taxonomy terms with which the
 * current entity is tagged.
 *
 * @return array
 */
function _dart_get_term_key_vals() {
  $key_vals = array();
  $terms = &drupal_static('dart_entity_targeting_terms', array());

  foreach ($terms as $term) {
    $key = _dart_get_term_key($term);
    $val = _dart_get_term_value($term);

    $key_vals[] = array(
      'key' => $key,
      'val' => $val,
      'eval' => FALSE,
    );
  }

  // If this is a taxonomy term page, include the term.
  if (arg(0) == 'taxonomy' && arg(1) == 'term' && is_numeric(arg(2))) {
    $term = taxonomy_term_load(arg(2));
    $key = _dart_get_term_key($term);
    $val = _dart_get_term_value($term);

    $key_vals[] = array(
      'key' => $key,
      'val' => $val,
      'eval' => FALSE,
    );
  }

  return $key_vals;
}

/**
 * Return an array of contexts to be used by token_replace().
 * @return array
 */
function _dart_get_token_context($tag = '') {
  $context = &drupal_static(__FUNCTION__);
  if (empty($context)) {
    if (!empty($tag)) {
      $context['dart_tag'] = $tag;
    }
    if (arg(0) == 'node' && is_numeric(arg(1))) {
      $context['node'] = node_load(arg(1));
    }
    if (arg(0) == 'taxonomy' && is_numeric(arg(2))) {
      $context['term'] = taxonomy_term_load(arg(2));
    }
    $context['menu'] = menu_load('main-menu');

    // Allow other modules to alter the current token context.
    drupal_alter('dart_token_context', $context);
  }

  return $context;
}

/**
 * Defines what formatters are available that can act upon taxonomy terms. These
 * functions define how the terms will be displayed when included in DART tags.
 */
function _dart_term_formatters() {
  $options = array(
    '_dart_term_formatter_tid' => 'Term ID',
    '_dart_term_formatter_truncated' => 'Truncated Term Name (6 chars)',
    '_dart_term_formatter_full' => 'Full Term Name',
  );

  drupal_alter('dart_taxonomy_callbacks', $options);

  return $options;
}

/**
 * Returns the tid to be used when displaying the term within a DART ad tag.
 *
 * @param object $term
 *
 * @return integer
 */
function _dart_term_formatter_tid($term) {
  return $term->tid;
}

/**
 * Returns the first six characters (lowercase) of the term name without spaces
 * or punctuation to be used when displaying the term within a DART ad tag.
 *
 * @param object $term
 *
 * @return string
 */
function _dart_term_formatter_truncated($term, $char_count = 6) {
  return drupal_substr(drupal_strtolower(preg_replace("/[^A-Za-z0-9]/", "", $term->name )), 0, $char_count);
}

/**
 * Returns the full (lowercase) term name without spaces or punctuation to be
 * used when displaying the term within a DART ad tag.
 *
 * @param object $term
 *
 * @return string
 */
function _dart_term_formatter_full($term) {
  return drupal_strtolower(preg_replace("/[^A-Za-z0-9_\-]/", "", str_replace(' ', '_', $term->name) ));
}

/**
 * Template preprocess function for dart tags.
 */
function template_preprocess_dart_tag(&$variables) {
  $tag = $variables['tag'];

  $variables['attr']['class'] = 'dart-tag dart-name-' . $tag->machinename;
  $variables['json_tag'] = drupal_json_encode($tag);
  $variables['load_last']   = variable_get('dart_load_last', '0');

  if (isset($tag->mode) && $tag->mode == 'test') {
    $variables['show_script_tag'] = TRUE;
    $variables['show_noscript_tag'] = TRUE;
  }
  else {
    $variables['show_script_tag'] = !$tag->settings['options']['scriptless'];
    $variables['show_noscript_tag'] = variable_get('dart_noscript', 1);
  }

  $variables['static_tag'] = l(theme('image', array('path' => $tag->noscript['src'])), $tag->noscript['href'], array('html' => TRUE));
  $variables['noscript_tag'] = $variables['show_noscript_tag'] ? '<noscript>' . $variables['static_tag'] . '</noscript>' : '';
  $variables['tag'] = $tag;
}
